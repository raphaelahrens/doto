#!/usr/bin/env python2
# -*- coding: utf-8 -*-

"""
The Done!Tools are a collection of tools to handle task and events.


doto add  "Title" "descripton"
doto list
doto

"""

import argparse
import sys
import util
import config
import importlib
import pkgutil
import db
import cli
import cli.cmd


EXIT_CODES = util.enum(unknown_cmd=1)

def import_commands():
    commands = {}
    for __, modname, ispkg in pkgutil.iter_modules(cli.cmd.__path__, cli.cmd.__name__ + "."):
        if ispkg is False:
            module = importlib.import_module(modname)
            commands[module.COMMAND] = module
    return commands


def init_parser(commands):
    parser = argparse.ArgumentParser(prog='doto', description="The Done!Tools are a collection of tools to handle task and events.", epilog="")
    subparsers = parser.add_subparsers(help='command', dest="cmd")
    for cmd in commands:
        cmd.init_parser(subparsers)
    return parser


def main():
    # Init phase
    cmds = import_commands()
    parser = init_parser(cmds.values())
    args = parser.parse_args()
    store = db.DBStore(config.TASK_STORE)

    # execute command
    cmds[args.cmd].main(store, args)
    store.close()

if __name__ == "__main__":
    main()
